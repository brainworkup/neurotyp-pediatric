---
title: "Pluck Tables from WISC-5"
params:
  patient: Felix
  test:
    label: "Test"
    value: [wisc5]
    input: select
    multiple: no
  test_name:
    label: "Test Name"
    value: [WISC-V]
    input: select
    multiple: no
    choices:
      - WISC-5
      - WISC-V
  file:
    label: "No file selected"
    value: file
    input: file
  pages: [2,2,2,2,2,3,6]
  table1:
    label: "Verbal Comprehension (VCI)"
    value: [Similarities]
    input: select
    multiple: yes
    choices:
      - Similarities
      - Vocabulary
      - Information
      - Comprehension
  table2:
    label: "Visual Spatial (VSI)"
    value: [Block Design]
    input: select
    multiple: yes
    choices:
      - Block Design
      - Visual Puzzles
  table3:
    label: "Fluid Reasoning (FRI)"
    value: [Matrix Reasoning]
    input: select
    multiple: yes
    choices:
      - Matrix Reasoning
      - Figure Weights
      - Picture Concepts
      - Arithmetic
  table4:
    label: "Working Memory (WMI)"
    value: [Letter-Number Sequencing]
    input: select
    multiple: yes
    choices:
      - Digit Span
      - Picture Span
      - Letter-Number Sequencing
  table5:
    label: "Processing Speed (PSI)"
    value: [Coding]
    input: select
    multiple: yes
    choices:
      - Coding
      - Symbol Search
      - Cancellation
  table6:
    label: "Composite Score Summary"
    value: ""
    input: select
    multiple: yes
    choices:
      - Verbal Comprehension (VCI)
      - Visual Spatial (VSI)
      - Fluid Reasoning (FRI)
      - Working Memory (WMI)
      - Processing Speed (PSI)
      - Full Scale IQ (FSIQ)
  table7:
    label: "Ancillary compoiste scores"
    value: "General Ability (GAI)"
    input: select
    multiple: yes
    choices:
      - VECI Verbal Comprehension (VCI)
      - EFI
      - QRI
      - AWMI
      - NVI
      - General Ability (GAI)
      - CPI
  table8:
    label: "Perceptual Reasoning Process Score Summary" #TODO:
    value: [Block Design No Time Bonus]
    input: select
    multiple: yes
    choices:
      - Block Design No Time Bonus
  table9:
    label: "Working Memory Process Score Summary" #TODO:
    value: [Digit Span Forward]
    input: select
    multiple: yes
    choices:
      - Digit Span Forward
      - Digit Span Backward
      - Digit Span Sequencing
      - Longest Digit Span Forward
      - Longest Digit Span Backward
      - Longest Digit Span Sequence
      - Longest Letter-Number Sequence
  colnames1:
    label: "Tables 1-5 Column Names"
    value: [domain, scale, abbrev, raw_score, score, percentile, age_equiv, sem]
    input: select
    multiple: yes
  colnames2:
    label: "Tables 6-7 Column Names"
    value: [scale, abbrev, raw_score, score, percentile, ci_95, category, sem]
    input: select
    multiple: yes
  colnames3:
    label: "Table 8 Column Names"
    value: [scale, abbrev, raw_score, score]
    input: select
    multiple: yes
  colnames4:
    label: "Table 9 Column Names"
    value: [scale, abbrev, raw_score, base_rate]
    input: select
    multiple: yes
  keep1:
    label: "Variables to Keep, Set 1"
    value: [scale, raw_score, score, percentile]
    input: select
    multiple: yes
    choices:
      - scale
      - raw_score
      - score
      - percentile
      - age_equiv
  keep2:
    label: "Variables to Keep, Set 2"
    value: [scale, raw_score, score, percentile, ci_95]
    input: select
    multiple: yes
# Domains to evaluate or not
  eval_iq:
    label: "General Cognitive Ability"
    value: TRUE
  eval_vci:
    label: "Verbal/Language"
    value: TRUE
  eval_pri:
    label: "Visual Perception/Construction"
    value: TRUE
  eval_wmi:
    label: "Working Memory"
    value: TRUE
  eval_psi:
    label: "Processing Speed"
    value: TRUE
  eval_bd:
    label: "Block Design No Time Bonus"
    value: FALSE
  eval_span:
    label: "Longest Span Subtests"
    value: FALSE
  match:
    label: "Subset/Match Rows"
    input: checkbox
    value: FALSE
output:
  rmdformats::robobook:
    highlight: kate
---

# WISC-5

## Load libraries

```{r setup, include = FALSE}
Sys.setenv(JAVA_HOME = "/Library/Java/JavaVirtualMachines/graalvm-community-openjdk-22.0.1+8.1/Contents/Home")
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = TRUE,
  message = TRUE,
  warning = FALSE,
  error = TRUE
)
library(dplyr)
library(hablar)
library(here)
library(knitr)
library(magrittr)
library(purrr)
library(readr)
library(rJava)
library(rmarkdown)
library(rmdformats)
library(shiny)
library(snakecase)
library(tabulapdf)
library(tibble)
library(tidyr)
library(tidyverse)
library(bwu)
```

## Patient

```{r patient}
patient <- params$patient
```

## Test

```{r test}
test <- params$test
test_name <- params$test_name
version <- params$version
```

## Upload/attach PDF

```{r choose}
file <- file.choose()
saveRDS(file, "file_path.rds")
# file <- params$file
```

## Pages

```{r pages}
pages <- params$pages
```

## Extract Areas with `tabulapdf`

```{r eval = FALSE}
library(tabulapdf)

# locate areas and extract
plucked_tables_wisc5 <- tabulapdf::extract_areas(
  file = file,
  pages = pages,
  method = "stream",
  output = "matrix"
)

# Loop over the list and write each matrix to a CSV file
for (i in seq_along(plucked_tables_wisc5)) {
  write.csv(plucked_tables_wisc5[[i]], file = paste0(test, "_", i, ".csv"), row.names = FALSE)
}

# Save the entire list to an R data file
save(plucked_tables_wisc5, file = "plucked_tables_wisc5.RData")
```

```{r}
# Load the entire list from an R data file
load("plucked_tables_wisc5.RData")
```

```{r}
# Define the replacements vector
replacements <- c(
  "Similarities", "Vocabulary", "Information", "Comprehension",
  "Block Design", "Visual Puzzles", "Matrix Reasoning", "Figure Weights",
  "Picture Concepts", "Arithmetic", "Digit Span", "Picture Span",
  "Letter-Number Sequencing", "Coding", "Symbol Search", "Cancellation",
  "Verbal Comprehension (VCI)", "Visual Spatial (VSI)", "Fluid Reasoning (FRI)",
  "Working Memory (WMI)", "Processing Speed (PSI)", "Full Scale IQ (FSIQ)", "General Ability (GAI)"
)

# Define the replacement function
replace_scale_names <- function(df, replacements) {
  scale_column <- ifelse("scale" %in% names(df), "scale", "abbrev")
  df[[scale_column]] <- sapply(df[[scale_column]], function(x) {
    for (replacement in replacements) {
      x <- gsub(pattern = paste0("\\(", replacement, "\\)"), replacement, x)
    }
    return(x)
  })
  return(df)
}

# Sample list of data frames
plucked_tables_wisc5 <- list(
  data.frame(domain = c("Verbal", "Comprehension", "", ""), scale = c("Similarities", "Vocabulary", "(Information)", "(Comprehension)"), stringsAsFactors = FALSE),
  data.frame(domain = c("Visual Spatial", ""), scale = c("Block Design", "Visual Puzzles"), stringsAsFactors = FALSE),
  data.frame(domain = c("Fluid Reasoning", "", "", ""), scale = c("Matrix Reasoning", "Figure Weights", "(Picture Concepts)", "(Arithmetic)"), stringsAsFactors = FALSE),
  data.frame(domain = c("Working Memory", "", ""), scale = c("Digit Span", "Picture Span", "(Letter-Number Seq.)"), stringsAsFactors = FALSE),
  data.frame(domain = c("Processing Speed", "", ""), scale = c("Coding", "Symbol Search", "(Cancellation)"), stringsAsFactors = FALSE),
  data.frame(scale = c("Verbal Comprehension", "Visual Spatial", "Fluid Reasoning", "Working Memory", "Processing Speed", "Full Scale IQ"), abbrev = c("VCI", "VSI", "FRI", "WMI", "PSI", "FSIQ"), stringsAsFactors = FALSE),
  data.frame(scale = c("General Ability"), abbrev = c("GAI"), stringsAsFactors = FALSE)
)

# Apply the replacement function to each data frame in the list
plucked_tables_wisc5 <- lapply(plucked_tables_wisc5, replace_scale_names, replacements = replacements)

# Print the modified list of data frames
print(plucked_tables_wisc5)
```

## Change scale names

```{r}
table1[1, 1] <- c("Similarities")
table1[2, 1] <- c("Vocabulary")
table1[3, 1] <- c("Information")
table1[4, 1] <- c("Comprehension")
table1[5, 1] <- c("Block Design")
table1[6, 1] <- c("Visual Puzzles")
table1[7, 1] <- c("Matrix Reasoning")
table1[8, 1] <- c("Figure Weights")
table1[9, 1] <- c("Picture Concepts")
table1[10, 1] <- c("Arithmetic")
table1[11, 1] <- c("Digit Span")
table1[12, 1] <- c("Picture Span")
table1[13, 1] <- c("Letter-Number Sequencing")
table1[14, 1] <- c("Coding")
table1[15, 1] <- c("Symbol Search")
table1[16, 1] <- c("Cancellation")

table2[1, 1] <- c("Verbal Comprehension (VCI)")
table2[2, 1] <- c("Visual Spatial (VSI)")
table2[3, 1] <- c("Fluid Reasoning (FRI)")
table2[4, 1] <- c("Working Memory (WMI)")
table2[5, 1] <- c("Processing Speed (PSI)")
table2[6, 1] <- c("Full Scale IQ (FSIQ)")

table3[1, 1] <- c("Verbal (Expanded Crystallized) (VECI)")
table3[2, 1] <- c("Expanded Fluid (EFI)")
table3[3, 1] <- c("Quantitative Reasoning (QRI)")
table3[4, 1] <- c("Auditory Working Memory (AWMI)")
table3[5, 1] <- c("Nonverbal (NVI)")
table3[6, 1] <- c("General Ability (GAI)")
table3[7, 1] <- c("Cognitive Proficiency (CPI)")
# table3[1, 1] <- c("Naming Speed (NSI)")
# table3[2, 1] <- c("Symbol Translation (STI)")
# table3[3, 1] <- c("Storage & Retrieval (SRI)")

table4[1, 1] <- c("Block Design No Time Bonus")
table4[2, 1] <- c("Block Design Partial Score")
table4[3, 1] <- c("Digit Span Forward")
table4[4, 1] <- c("Digit Span Backward")
table4[5, 1] <- c("Digit Span Sequencing")
table4[6, 1] <- c("Cancellation Random")
table4[7, 1] <- c("Cancellation Structured")

# table4[1, 1] <- c("Naming Speed Literacy")
# table4[2, 1] <- c("Naming Speed Quantity")
# table4[3, 1] <- c("Immediate Symbol Translation")
# table4[4, 1] <- c("Delayed Symbol Translation")
# table4[5, 1] <- c("Recognition Symbol Translation")

# table6[1, 1] <- c("Longest Digit Span Forward")
# table6[2, 1] <- c("Longest Digit Span Backward")
# table6[3, 1] <- c("Longest Digit Span Sequence")
# table6[4, 1] <- c("Longest Picture Span Stimulus")
# table6[5, 1] <- c("Longest Picture Span Response")
# table6[6, 1] <- c("Longest Letter-Number Sequence")
# table6[7, 1] <- c("Block Design Dimension Errors")
# table6[8, 1] <- c("Block Design Rotation Errors")
# table6[9, 1] <- c("Coding Rotation Errors")
# table6[10, 1] <- c("Symbol Search Set Errors")
# table6[11, 1] <- c("Symbol Search Rotation Errors")
# table6[12, 1] <- c("Naming Speed Literacy Errors")
# table6[13, 1] <- c("Naming Speed Quantity Errors")
```

# WISC-5 Subtest Scores (Tables 1-5)

## Pluck and tidy tables

```{r}
process_table <- function(table_path, colnames, keep, table_value) {
  table <- readr::read_csv(table_path)

  # Rename columns
  names(table) <- colnames

  # Convert columns to double
  to_double <- c("raw_score", "score", "percentile")
  table[to_double] <- lapply(table[to_double], as.numeric)

  # Assign value to first column
  table[, 1] <- table_value

  # Select specified columns
  table <- table |> dplyr::select(all_of(keep))

  return(table)
}

# Paths to your CSV files
table_paths <- paste0("wisc5_", 1:7, ".csv")

# Extract parameters from the rmarkdown params
colnames <- params$colnames1
keep <- params$keep1
table_value <- params$table

# Process all tables using purrr::map
# plucked_tables_wisc5 now contains the processed tables
plucked_tables_wisc5 <- map(table_paths, ~ process_table(.x, colnames, keep, table_value))
```

# VCI (Table 1)

## extract rows with data

```{r}
# Function to filter out rows with no real data (assumes real data rows have non-NA and non-empty values in key columns)
filter_real_data <- function(table, key_columns) {
  table %>%
    filter(rowSums(is.na(select(., all_of(key_columns))) | select(., all_of(key_columns)) == "") < length(key_columns))
}

# Assuming key_columns are those columns which must have data
key_columns <- c("raw_score", "score", "percentile")

# Extract and filter table1
table1_all_rows <- plucked_tables_wisc5[[1]]
table1 <- filter_real_data(table1_all_rows, key_columns)
```

## Mutate columns

```{r}
table1 <- bwu::gpluck_make_columns(
  table1,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Verbal/Language",
  subdomain = "",
  narrow = "",
  pass = "Sequential",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = "",
  result = ""
)

# Test score ranges
table1 <- bwu::gpluck_make_score_ranges(
  table = table1,
  test_type = "npsych_test"
)
```

## Subdomains

```{r subdomain1, eval = params$eval_vci}
table1 <-
  table1 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Similarities" ~ "Reasoning",
      scale == "Vocabulary" ~ "Knowledge",
      scale == "Information" ~ "Knowledge",
      scale == "Comprehension" ~ "Reasoning",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Similarities" ~ "Word Reasoning",
      scale == "Vocabulary" ~ "Word Knowledge",
      scale == "Information" ~ "General World Knowledge",
      scale == "Comprehension" ~ "Acquired Knowledge",
      TRUE ~ as.character(narrow)
    )
  )
```

## Scale descriptions

```{r}
table1 <-
  table1 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Similarities" ~ "Verbal inductive reasoning",
      scale ==
        "Vocabulary" ~ "Word/lexical knowledge",
      scale ==
        "Information" ~ "Acquired knowledge/ability to acquire, retain, and retrieve general factual knowledge",
      scale ==
        "Comprehension" ~ "Practical knowledge and judgment of general principles and social situations",
      TRUE ~ as.character(description)
    )
  )
```

## Glue results

```{r}
table1 <-
  table1 %>%
  dplyr::mutate(
    result = glue::glue(
      "{description} was {range}.\n"
    )
  )
```

## Relocate variables

```{r}
table1 <- table1 |> dplyr::relocate(c(raw_score, score, ci_95, percentile, range), .before = test)
```

# VSI (Table 2)

```{r}
# Function to filter out rows with no real data (assumes real data rows have non-NA and non-empty values in key columns)
filter_real_data <- function(table, key_columns) {
  table %>%
    filter(rowSums(is.na(select(., all_of(key_columns))) | select(., all_of(key_columns)) == "") < length(key_columns))
}

# Assuming key_columns are those columns which must have data
key_columns <- c("raw_score", "score", "percentile")

# Extract and filter table1
table2_all_rows <- plucked_tables_wisc5[[2]]
table2 <- filter_real_data(table2_all_rows, key_columns)
```

## Mutate columns

```{r}
table2 <- bwu::gpluck_make_columns(
  table2,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Visual Perception/Construction",
  subdomain = "",
  narrow = "",
  timed = "",
  verbal = "Nonverbal",
  pass = "Simultaneous",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r}
table2 <- bwu::gpluck_make_score_ranges(table = table2, test_type = "npsych_test")
```

## Subdomains

```{r}
table2 <-
  table2 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Block Design" ~ "Construction",
      scale == "Visual Puzzles" ~ "Visualization",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r}
table2 <-
  table2 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Block Design" ~ "Block Construction",
      scale == "Visual Puzzles" ~ "Visualization",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r}
table2 <-
  table2 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Block Design" ~ "Timed",
      scale == "Visual Puzzles" ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )
```

## Description

```{r}
table2 <-
  table2 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale ==
        "Block Design" ~ "Understanding visual-spatial relationships to construct geometric designs from a model",
      scale ==
        "Visual Puzzles" ~ "Generate visual images in the mind's eye",
      TRUE ~ as.character(description)
    )
  )
```

## Glue results

```{r}
table2 <-
  table2 %>%
  dplyr::mutate(
    result = glue::glue(
      "{description} was {range}.\n"
    )
  )
```

## Relocate variables

```{r}
table2 <- table2 |> dplyr::relocate(c(raw_score, score, ci_95, percentile, range), .before = test)
```

# FRI (Table 3)

```{r}
# Function to filter out rows with no real data (assumes real data rows have non-NA and non-empty values in key columns)
filter_real_data <- function(table, key_columns) {
  table %>%
    filter(rowSums(is.na(select(., all_of(key_columns))) | select(., all_of(key_columns)) == "") < length(key_columns))
}

# Assuming key_columns are those columns which must have data
key_columns <- c("raw_score", "score", "percentile")

# Extract and filter table1
table3_all_rows <- plucked_tables_wisc5[[3]]
table3 <- filter_real_data(table3_all_rows, key_columns)
```

## Mutate columns

```{r}
table3 <- bwu::gpluck_make_columns(
  table3,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Visual Perception/Construction",
  subdomain = "",
  narrow = "",
  timed = "",
  verbal = "Nonverbal",
  pass = "Simultaneous",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r}
table3 <- bwu::gpluck_make_score_ranges(table = table3, test_type = "npsych_test")
```

## Subdomains

```{r}
table3 <-
  table3 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Matrix Reasoning" ~ "Reasoning",
      scale == "Figure Weights" ~ "Reasoning",
      scale == "Picture Concepts" ~ "Reasoning",
      scale == "Arithmetic" ~ "Reasoning",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r}
table3 <-
  table3 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Matrix Reasoning" ~ "Fluid Reasoning",
      scale == "Figure Weights" ~ "Quantitative Reasoning",
      scale == "Picture Concepts" ~ "Fluid Reasoning",
      scale == "Arithmetic" ~ "Quantitative Reasoning",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r}
table3 <-
  table3 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Matrix Reasoning" ~ "Untimed",
      scale == "Figure Weights" ~ "Timed",
      scale == "Picture Concepts" ~ "Untimed",
      scale == "Arithmetic" ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )
```

## Description

```{r}
table3 <-
  table3 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Matrix Reasoning" ~ "Inductive reasoning and nonverbal problem-solving",
      scale == "Figure Weights" ~ "General sequential (deductive) reasoning and quantitative reasoning", # TODO:
      scale == "Picture Concepts" ~ "Reasoning and semantic matching",
      scale == "Arithmetic" ~ "Solving math word problems in working memory",
      TRUE ~ as.character(description)
    )
  )
```

## Glue results

```{r}
table3 <-
  table3 %>%
  dplyr::mutate(
    result = glue::glue(
      "{description} was {range}.\n"
    )
  )
```

## Relocate variables

```{r}
table3 <- table3 |> dplyr::relocate(c(raw_score, score, ci_95, percentile, range), .before = test)
```

# WMI (Table 4)

```{r}
# Function to filter out rows with no real data (assumes real data rows have non-NA and non-empty values in key columns)
filter_real_data <- function(table, key_columns) {
  table %>%
    filter(rowSums(is.na(select(., all_of(key_columns))) | select(., all_of(key_columns)) == "") < length(key_columns))
}

# Assuming key_columns are those columns which must have data
key_columns <- c("raw_score", "score", "percentile")

# Extract and filter table1
table4_all_rows <- plucked_tables_wisc5[[4]]
table4 <- filter_real_data(table4_all_rows, key_columns)
```

## Mutate columns

```{r}
table4 <- bwu::gpluck_make_columns(
  table4,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Attention/Executive",
  subdomain = "Working Memory",
  narrow = "",
  pass = "Attention",
  verbal = "Verbal",
  timed = "Untimed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r}
table4 <- bwu::gpluck_make_score_ranges(
  table = table4,
  test_type = "npsych_test"
)
```

## Subdomains

```{r}
table4 <-
  table4 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Digit Span" ~ "Working Memory",
      scale == "Picture Span" ~ "Working Memory",
      scale == "Letter-Number Sequencing" ~ "Working Memory",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r narrow4, eval = params$eval_wmi}
table4 <-
  table4 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Digit Span" ~ "Verbal Working Memory",
      scale == "Picture Span" ~ "Nonverbal Working Memory",
      scale == "Letter-Number Sequencing" ~ "Verbal Working Memory",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed vs Untimed

```{r timed4, eval = params$eval_wmi}
table4 <-
  table4 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Digit Span" ~ "Untimed",
      scale == "Picture Span" ~ "Untimed",
      scale == "Letter-Number Sequencing" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

## PASS model

```{r pass4, eval = params$eval_wmi}
table4 <-
  table4 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Digit Span" ~ "Attention",
      scale == "Picture Span" ~ "Attention",
      scale == "Letter-Number Sequencing" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Scale descriptions

```{r}
table4 <-
  table4 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Digit Span" ~ "Registering, maintaining, and manipulating auditory information",
      scale == "Picture Span" ~ "Maintenance and resequencing of progressively lengthier sets of pictures in spatial working memory",
      scale == "Letter-Number Sequencing" ~ "Maintenance and resequencing of progressively lengthier number and letter strings in working memory",
      TRUE ~ as.character(description)
    )
  )
```

## Glue results

```{r}
table4 <-
  table4 %>%
  dplyr::mutate(
    result = glue::glue(
      "{description} was {range}.\n"
    )
  )
```

## Relocate variables

```{r}
table4 <- table4 |> dplyr::relocate(c(raw_score, score, ci_95, percentile, range), .before = test)
```

# PSI (Table 5)

```{r}
# Function to filter out rows with no real data (assumes real data rows have non-NA and non-empty values in key columns)
filter_real_data <- function(table, key_columns) {
  table %>%
    filter(rowSums(is.na(select(., all_of(key_columns))) | select(., all_of(key_columns)) == "") < length(key_columns))
}

# Assuming key_columns are those columns which must have data
key_columns <- c("raw_score", "score", "percentile")

# Extract and filter table1
table5_all_rows <- plucked_tables_wisc5[[5]]
table5 <- filter_real_data(table5_all_rows, key_columns)
```

## Mutate columns

```{r}
table5 <- bwu::gpluck_make_columns(
  table5,
  range = "",
  ci_95 = "",
  test = params$test,
  test_name = params$test_name,
  domain = "Attention/Executive",
  subdomain = "Processing Speed",
  narrow = "",
  pass = "Planning",
  verbal = "Nonverbal",
  timed = "Timed",
  test_type = "npsych_test",
  score_type = "scaled_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r}
table5 <- bwu::gpluck_make_score_ranges(table = table5, test_type = "npsych_test")
```

## Subdomains

```{r}
table5 <-
  table5 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Coding" ~ "Processing Speed",
      scale == "Symbol Search" ~ "Processing Speed",
      scale == "Cancellation" ~ "Processing Speed",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomains

```{r}
table5 <-
  table5 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Coding" ~ "Cognitive Efficiency",
      scale == "Symbol Search" ~ "Cognitive Efficiency",
      scale == "Cancellation" ~ "Attentional Fluency",
      TRUE ~ as.character(narrow)
    )
  )
```

## PASS model

```{r}
table5 <-
  table5 |>
  dplyr::mutate(
    pass = dplyr::case_when(
      scale == "Cancellation" ~ "Attention",
      scale == "Coding" ~ "Planning",
      scale == "Symbol Search" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

## Scale descriptions

```{r}
table5 <-
  table5 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Coding" ~ "Efficiency of psychomotor speed, visual scanning ability, and visual-motor coordination",
      scale == "Symbol Search" ~ "Visual-perceptual decision-making speed",
      scale == "Cancellation" ~ "Selective visual attention, visual discrimination, and visual-perceptual processing",
      TRUE ~ as.character(description)
    )
  )
```

## Glue results

```{r}
table5 <-
  table5 %>%
  dplyr::mutate(
    result = glue::glue(
      "{description} was {range}.\n"
    )
  )
```

## Relocate variables

```{r}
table5 <- table5 |> dplyr::relocate(c(raw_score, score, ci_95, percentile, range), .before = test)
```

# WISC-5 Index scores (Table 6)

```{r}
process_table <- function(table_path, colnames, keep, table_value) {
  table <- readr::read_csv(table_path)

  # Rename columns
  names(table) <- colnames

  # Convert columns to double
  to_double <- c("raw_score", "score", "percentile")
  table[to_double] <- lapply(table[to_double], as.numeric)

  # Assign value to first column
  table[, 1] <- table_value

  # Select specified columns
  table <- table |> dplyr::select(all_of(keep))

  return(table)
}

# Paths to your CSV files
table_paths <- paste0("wisc5_", 6:7, ".csv") # check here if have issues

# Extract parameters from the rmarkdown params
colnames <- params$colnames2
keep <- params$keep2
table_value <- params$table6 # check on this

# Process all tables using purrr::map
plucked_tables_wisc5 <- map(table_paths, ~ process_table(.x, colnames, keep, table_value))
```

```{r}
# Function to filter out rows with no real data (assumes real data rows have non-NA and non-empty values in key columns)
filter_real_data <- function(table, key_columns) {
  table %>%
    filter(rowSums(is.na(select(., all_of(key_columns))) | select(., all_of(key_columns)) == "") < length(key_columns))
}

# Assuming key_columns are those columns which must have data
key_columns <- c("raw_score", "score", "percentile")

# Extract and filter table1
table6_all_rows <- plucked_tables_wisc5[[1]] # watch for this
table6 <- filter_real_data(table6_all_rows, key_columns)
```

## Mutate columns

```{r}
table6 <- readr::read_csv("wisc5_6.csv")
names(table6) <- params$colnames2

# Use unite to concatenate the first two columns and add parentheses around the abbrev data
table6 <- table6 %>%
  unite("scale", scale, abbrev, sep = " (", remove = TRUE) %>%
  mutate(scale = paste0(scale, ")")) %>%
  relocate(scale, .before = raw_score)

table6 <- table6 |> dplyr::select(all_of(params$keep2))

table6 <- bwu::gpluck_make_columns(
  table6,
  range = "",
  test = params$test,
  test_name = params$test_name,
  domain = "General Cognitive Ability",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "npsych_test",
  score_type = "standard_score",
  description = "",
  result = ""
)
```

## Test score ranges

```{r}
table6 <- bwu::gpluck_make_score_ranges(table = table6, test_type = "npsych_test")
```

## Subdomain

```{r}
table6 <-
  table6 |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Knowledge",
      scale == "Visual Spatial (VSI)" ~ "Visuospatial Processing",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Reasoning",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow subdomain

```{r}
table6 <-
  table6 |>
  dplyr::mutate(
    narrow = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Knowledge",
      scale == "Visual Spatial (VSI)" ~ "Visuospatial Processing",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Reasoning",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      TRUE ~ as.character(narrow)
    )
  )
```

## Verbal vs Nonverbal

```{r}
table6 <-
  table6 |>
  dplyr::mutate(
    verbal = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Verbal",
      scale == "Visual Spatial (VSI)" ~ "Nonverbal",
      scale == "Fluid Reasoning (FRI)" ~ "Nonverbal", # unless arithmetic too
      scale == "Working Memory (WMI)" ~ "",
      scale == "Processing Speed (PSI)" ~ "Nonverbal",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      TRUE ~ as.character(verbal)
    )
  )
```

## Timed vs Untimed

```{r}
table6 <-
  table6 |>
  dplyr::mutate(
    timed = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Untimed",
      scale == "Visual Spatial (VSI)" ~ "Timed",
      scale == "Fluid Reasoning (FRI)" ~ "",
      scale == "Working Memory (WMI)" ~ "Untimed",
      scale == "Processing Speed (PSI)" ~ "Timed",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      TRUE ~ as.character(timed)
    )
  )
```

## Descriptions

```{r}
table6 <-
  table6 |>
  dplyr::mutate(
    description = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Verbal Comprehension (i.e., the ability to verbalize meaningful concepts, think about verbal information, and express oneself using words)",
      scale == "Visual Spatial (VSI)" ~ "Visual Spaital is not an independent factor",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Reasoning (i.e., the ability to use reasoning to identify and apply solutions to problems)",
      scale == "Working Memory (WMI)" ~ "Working Memory (*G*wm)",
      scale == "Processing Speed (PSI)" ~ "Processing Speed (*G*s)",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence (*g*)",
      scale == "General Ability (GAI)" ~ "A subset of intellectual functioning with reduced influences of working memory and processing speed",
      TRUE ~ as.character(description)
    )
  )
```

## Glue result

```{r}
table6 <-
  table6 |>
  dplyr::mutate(
    result = dplyr::case_when(
      scale == "Verbal Comprehension (VCI)" ~ glue::glue(
        "{description} was classified as {range} and ranked at the {percentile}th percentile.\n"
      ),
      scale == "Visual Spatial (VSI" ~ glue::glue(
        "{description} was classified as {range} and ranked at the {percentile}th percentile.\n"
      ),
      scale == "Fluid Reasoning (FRI)" ~ glue::glue(
        "{description} was classified as {range} and ranked at the {percentile}th percentile.\n"
      ),
      scale == "Working Memory (WMI)" ~ glue::glue(
        "{description} fell in the {range} range.\n"
      ),
      scale == "Processing Speed (PSI)" ~ glue::glue(
        "{description} was {range}.\n"
      ),
      scale == "Full Scale IQ (FSIQ)" ~ glue::glue(
        "{description} was {range} overall.\n"
      ),
      scale == "General Ability (GAI)" ~ glue::glue(
        "{description} was {range} and ranked at the {percentile}th percentile, indicating performance as good as or better than {percentile}% of same-age peers from the general population.\n"
      ),
      TRUE ~ as.character(result)
    )
  )
```

## Relocate variables

```{r}
table6 <- table6 |> dplyr::relocate(c(raw_score, score, ci_95, percentile, range), .before = test)
```

# Combine tables

```{r}
wisc5 <- rbind(table6, table1, table2, table3, table4, table5)
```

## Write out final csv

```{r}
readr::write_csv(wisc5, here::here("data", "csv", "wisc5.csv"))
```

# NOTE: TODO: add 3 other tables 7/1/24

## Domain

```{r domains-table1}
table1 <-
  table1 |>
  mutate(
    domain = case_when(
      scale == "Similarities" ~ "Verbal/Language",
      scale == "Vocabulary" ~ "Verbal/Language",
      scale == "Information" ~ "Verbal/Language",
      scale == "Comprehension" ~ "Verbal/Language",
      scale == "Block Design" ~ "Visual Perception/Construction",
      scale == "Visual Puzzles" ~ "Visual Perception/Construction",
      scale == "Matrix Reasoning" ~ "Visual Perception/Construction",
      scale == "Figure Weights" ~ "Visual Perception/Construction",
      scale == "Picture Concepts" ~ "Visual Perception/Construction",
      scale == "Arithmetic" ~ "Attention/Executive",
      scale == "Digit Span" ~ "Attention/Executive",
      scale == "Picture Span" ~ "Attention/Executive",
      scale == "Letter-Number Sequencing" ~ "Attention/Executive",
      scale == "Coding" ~ "Attention/Executive",
      scale == "Cancellation" ~ "Attention/Executive",
      scale == "Symbol Search" ~ "Attention/Executive",
      TRUE ~ as.character(domain)
    )
  )
```

```{r domains-table2}
table2 <-
  table2 |>
  mutate(
    domain = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Intelligence/General Ability",
      scale == "Visual Spatial (VSI)" ~ "Intelligence/General Ability",
      scale == "Fluid Reasoning (FRI)" ~ "Intelligence/General Ability",
      scale == "Working Memory (WMI)" ~ "Attention/Executive",
      scale == "Processing Speed (PSI)" ~ "Attention/Executive",
      scale == "Full Scale IQ (FSIQ)" ~ "Intelligence/General Ability",
      TRUE ~ as.character(domain)
    )
  )
```

```{r domains-table3}
table3 <-
  table3 |>
  mutate(
    domain = case_when(
      ## Ancillary
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "Intelligence/General Ability",
      scale == "Expanded Fluid (EFI)" ~ "Intelligence/General Ability",
      scale == "Quantitative Reasoning (QRI)" ~ "Intelligence/General Ability",
      scale == "Auditory Working Memory (AWMI)" ~ "Attention/Executive",
      scale == "Nonverbal (NVI)" ~ "Intelligence/General Ability",
      scale == "General Ability (GAI)" ~ "Intelligence/General Ability",
      scale == "Cognitive Proficiency (CPI)" ~ "Intelligence/General Ability",
      ## Complementary
      scale == "Naming Speed (NSI)" ~ "Verbal/Language",
      scale == "Symbol Translation (STI)" ~ "Memory",
      scale == "Storage & Retrieval (SRI)" ~ "Memory",
      TRUE ~ as.character(domain)
    )
  )
```

```{r domains-table4}
table4 <-
  table4 |>
  mutate(
    domain = case_when(
      ## Total Raw Score to Scaled Score Conversion
      scale == "Block Design No Time Bonus" ~ "Visual Perception/Construction",
      scale == "Block Design Partial Score" ~ "Visual Perception/Construction",
      scale == "Digit Span Backward" ~ "Attention/Executive",
      scale == "Digit Span Forward" ~ "Attention/Executive",
      scale == "Digit Span Sequencing" ~ "Attention/Executive",
      scale == "Cancellation Random" ~ "Attention/Executive",
      scale == "Cancellation Structured" ~ "Attention/Executive",
      TRUE ~ as.character(domain)
    )
  )
```

```{r domains-table4}
# table4 <-
#   table4 |>
#   mutate(
#     domain = case_when(
#       ## Ancillary
#       scale == "Naming Speed Literacy" ~ "Verbal/Language",
#       scale == "Naming Speed Quantity" ~ "Verbal/Language",
#       scale == "Immediate Symbol Translation" ~ "Memory",
#       scale == "Delayed Symbol Translation" ~ "Memory",
#       scale == "Recognition Symbol Translation" ~ "Memory",
#       TRUE ~ as.character(domain)
#     )
#   )
```

```{r domains-table6}
# table6 <-
#   table6 |>
#   mutate(
#     domain = case_when(
#       ## Total Raw Score to Base Rate Conversion
#       scale == "Longest Digit Span Backward" ~ "Attention/Executive",
#       scale == "Longest Digit Span Forward" ~ "Attention/Executive",
#       scale == "Longest Digit Span Sequence" ~ "Attention/Executive",
#       scale == "Longest Picture Span Response" ~ "Attention/Executive",
#       scale == "Longest Picture Span Stimulus" ~ "Attention/Executive",
#       scale == "Longest Letter-Number Sequence" ~ "Attention/Executive",
#       scale == "Block Design Dimension Errors" ~ "Visual Perception/Construction",
#       scale == "Block Design Rotation Errors" ~ "Visual Perception/Construction",
#       scale == "Coding Rotation Errors" ~ "Attention/Executive",
#       scale == "Symbol Search Set Errors" ~ "Attention/Executive",
#       scale == "Symbol Search Rotation Errors" ~ "Attention/Executive",
#       scale == "Naming Speed Literacy Errors" ~ "Verbal/Language",
#       scale == "Naming Speed Quantity Errors" ~ "Verbal/Language",
#       TRUE ~ as.character(domain)
#     )
#   )
```

## Subdomain

As necessary.

```{r subdomains-table1}
table1 <-
  table1 |>
  mutate(
    subdomain = case_when(
      scale == "Arithmetic" ~ "Short-Term Memory",
      scale == "Block Design" ~ "Visual Processing",
      scale == "Cancellation" ~ "Processing Speed",
      scale == "Coding" ~ "Processing Speed",
      scale == "Comprehension" ~ "Crystallized Intelligence",
      scale == "Digit Span" ~ "Short-Term Memory",
      scale == "Figure Weights" ~ "Fluid Reasoning",
      scale == "Information" ~ "Crystallized Intelligence",
      scale == "Letter-Number Sequencing" ~ "Short-Term Memory",
      scale == "Matrix Reasoning" ~ "Fluid Reasoning",
      scale == "Picture Concepts" ~ "Fluid Reasoning",
      scale == "Picture Span" ~ "Short-Term Memory",
      scale == "Similarities" ~ "Crystallized Intelligence",
      scale == "Symbol Search" ~ "Processing Speed",
      scale == "Visual Puzzles" ~ "Visual Processing",
      scale == "Vocabulary" ~ "Crystallized Intelligence",
      TRUE ~ as.character(subdomain)
    )
  )
```

```{r subdomains-table2}
table2 <-
  table2 |>
  mutate(
    subdomain = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Visual Spatial (VSI)" ~ "Visual Processing",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Short-Term Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      TRUE ~ as.character(subdomain)
    )
  )
```

```{r subdomains-table3}
table3 <-
  table3 |>
  mutate(
    subdomain = case_when(
      scale == "Auditory Working Memory (AWMI)" ~ "Short-Term Memory",
      scale == "Cognitive Proficiency (CPI)" ~ "Cognitive Efficiency",
      scale == "Expanded Fluid (EFI)" ~ "Fluid Intelligence",
      scale == "General Ability (GAI)" ~ "General Intelligence",
      scale == "Nonverbal (NVI)" ~ "Fluid Intelligence",
      scale == "Quantitative Reasoning (QRI)" ~ "Fluid Intelligence",
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "Crystallized Intelligence",
      scale == "Naming Speed (NSI)" ~ "Retrieval Fluency",
      scale == "Symbol Translation (STI)" ~ "Learning Efficiency",
      scale == "Storage & Retrieval (SRI)" ~ "Long-Term Storage and Retrieval",
      TRUE ~ as.character(subdomain)
    )
  )
```

```{r subdomains-table4}
table4 <-
  table4 |>
  mutate(
    subdomain = case_when(
      scale == "Block Design No Time Bonus" ~ "Visual Processing",
      scale == "Block Design Partial Score" ~ "Visual Processing",
      scale == "Digit Span Backward" ~ "Short-Term Memory",
      scale == "Digit Span Forward" ~ "Short-Term Memory",
      scale == "Digit Span Sequencing" ~ "Short-Term Memory",
      scale == "Cancellation Random" ~ "Processing Speed",
      scale == "Cancellation Structured" ~ "Processing Speed",
      TRUE ~ as.character(subdomain)
    )
  )
```

```{r subdomains-table4}
# table4 <-
#   table4 |>
#   mutate(
#     subdomain = case_when(
#       ## Ancillary
#       scale == "Naming Speed Literacy" ~ "Naming Speed",
#       scale == "Naming Speed Quantity" ~ "Naming Speed",
#       scale == "Immediate Symbol Translation" ~ "Associative Memory",
#       scale == "Delayed Symbol Translation" ~ "Associative Memory",
#       scale == "Recognition Symbol Translation" ~ "Associative Memory",
#       TRUE ~ as.character(subdomain)
#     )
#   )
```

```{r subdomains-table6}
# table6 <-
#   table6 |>
#   mutate(
#     subdomain = case_when(
#       scale == "Block Design Dimension Errors" ~ "Fluid Reasoning",
#       scale == "Block Design Rotation Errors" ~ "Fluid Reasoning",
#       scale == "Coding Rotation Errors" ~ "Processing Speed",
#       scale == "Longest Digit Span Backward" ~ "Working Memory",
#       scale == "Longest Digit Span Forward" ~ "Attention",
#       scale == "Longest Digit Span Sequence" ~ "Working Memory",
#       scale == "Longest Letter-Number Sequence" ~ "Working Memory",
#       scale == "Longest Picture Span Response" ~ "Working Memory",
#       scale == "Longest Picture Span Stimulus" ~ "Working Memory",
#       scale == "Naming Speed Literacy Errors" ~ "Processing Speed",
#       scale == "Naming Speed Quantity Errors" ~ "Processing Speed",
#       scale == "Symbol Search Rotation Errors" ~ "Processing Speed",
#       scale == "Symbol Search Set Errors" ~ "Processing Speed",
#       TRUE ~ as.character(subdomain)
#     )
#   )
```

## Narrow subdomain

As necessary.

```{r narrow-table1}
table1 <-
  table1 |>
  mutate(
    narrow = case_when(
      scale == "Similarities" ~ "Verbal Reasoning",
      scale == "Vocabulary" ~ "Lexical Knowledge",
      scale == "Information" ~ "General Verbal Information",
      scale == "Comprehension" ~ "General Verbal Information",
      scale == "Block Design" ~ "Visualization",
      scale == "Visual Puzzles" ~ "Visualization",
      scale == "Matrix Reasoning" ~ "Induction",
      scale == "Figure Weights" ~ "General Sequential Reasoning",
      scale == "Picture Concepts" ~ "Induction",
      scale == "Arithmetic" ~ "Working Memory/Mathematical Achievement",
      scale == "Digit Span" ~ "Working Memory",
      scale == "Picture Span" ~ "Memory Span",
      scale == "Letter-Number Sequencing" ~ "Working Memory",
      scale == "Coding" ~ "Psychomotor Speed",
      scale == "Symbol Search" ~ "Perceptual Speed",
      scale == "Cancellation" ~ "Attentional Fluency",
      TRUE ~ as.character(narrow)
    )
  )
```

```{r narrow-table2}
table2 <-
  table2 |>
  mutate(
    narrow = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Crystallized Intelligence",
      scale == "Visual Spatial (VSI)" ~ "Fluid Intelligence",
      scale == "Fluid Reasoning (FRI)" ~ "Fluid Intelligence",
      scale == "Working Memory (WMI)" ~ "Working Memory",
      scale == "Processing Speed (PSI)" ~ "Processing Speed",
      scale == "Full Scale IQ (FSIQ)" ~ "General Intelligence",
      TRUE ~ as.character(narrow)
    )
  )
```

```{r narrow-table3}
table3 <-
  table3 |>
  mutate(
    narrow = case_when(
      scale == "Auditory Working Memory (AWMI)" ~ "Working Memory",
      scale == "Cognitive Proficiency (CPI)" ~ "Cognitive Efficiency",
      scale == "Expanded Fluid (EFI)" ~ "Fluid Intelligence",
      scale == "General Ability (GAI)" ~ "General Intelligence",
      scale == "Nonverbal (NVI)" ~ "Fluid Intelligence",
      scale == "Quantitative Reasoning (QRI)" ~ "Quantitative Reasoning",
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "Crystallized Intelligence",
      scale == "Naming Speed (NSI)" ~ "Naming Facility",
      scale == "Storage & Retrieval (SRI)" ~ "Retrieval Fluency",
      scale == "Symbol Translation (STI)" ~ "Learning Efficiency",
      TRUE ~ as.character(narrow)
    )
  )
```

```{r}
table4 <-
  table4 |>
  mutate(
    narrow = case_when(
      scale == "Block Design No Time Bonus" ~ "Visualization",
      scale == "Block Design Partial Score" ~ "Visualization",
      scale == "Cancellation Random" ~ "Perceptual Speed",
      scale == "Cancellation Structured" ~ "Perceptual Speed",
      scale == "Digit Span Backward" ~ "Working Memory",
      scale == "Digit Span Forward" ~ "Memory Span",
      scale == "Digit Span Sequencing" ~ "Working Memory",
      TRUE ~ as.character(narrow)
    )
  )
```

```{r narrow-table4}
# table4 <-
#   table4 |>
#   mutate(
#     narrow = case_when(
#       ## Ancillary
#       scale == "Naming Speed Literacy" ~ "Verbal Processing Speed",
#       scale == "Naming Speed Quantity" ~ "Verbal Processing Speed",
#       scale == "Immediate Symbol Translation" ~ "Associative Memory Learning",
#       scale == "Delayed Symbol Translation" ~ "Associative Memory Recall",
#       scale == "Recognition Symbol Translation" ~ "Associative Memory Recognition",
#       TRUE ~ as.character(narrow)
#     )
#   )
```

```{r narrow-table6}
# table6 <-
#   table6 |>
#   mutate(
#     narrow = case_when(
#       scale == "Block Design Dimension Errors" ~ "Visuoconstruction",
#       scale == "Block Design Rotation Errors" ~ "Visuoconstruction",
#       scale == "Coding Rotation Errors" ~ "Nonverbal Processing Speed",
#       scale == "Longest Digit Span Backward" ~ "Verbal Working Memory",
#       scale == "Longest Digit Span Forward" ~ "Verbal Attention",
#       scale == "Longest Digit Span Sequence" ~ "Verbal Working Memory",
#       scale == "Longest Letter-Number Sequence" ~ "Verbal Working Memory",
#       scale == "Longest Picture Span Response" ~ "Nonverbal Working Memory",
#       scale == "Longest Picture Span Stimulus" ~ "Nonverbal Working Memory",
#       scale == "Naming Speed Literacy Errors" ~ "Verbal Processing Speed",
#       scale == "Naming Speed Quantity Errors" ~ "Verbal Processing Speed",
#       scale == "Symbol Search Rotation Errors" ~ "Nonverbal Processing Speed",
#       scale == "Symbol Search Set Errors" ~ "Nonverbal Processing Speed",
#       TRUE ~ as.character(narrow)
#     )
#   )
```

## PASS model

As necessary.

```{r pass-table1}
table1 <-
  table1 |>
  mutate(
    pass = case_when(
      scale == "Information" ~ "Successive",
      scale == "Similarities" ~ "Successive",
      scale == "Vocabulary" ~ "Successive",
      scale == "Comprehension" ~ "Successive",
      scale == "Block Design" ~ "Simultaneous",
      scale == "Visual Puzzles" ~ "Simultaneous",
      scale == "Matrix Reasoning" ~ "Simultaneous",
      scale == "Figure Weights" ~ "Simultaneous",
      scale == "Picture Concepts" ~ "Simultaneous",
      scale == "Arithmetic" ~ "Successive",
      scale == "Digit Span" ~ "Successive",
      scale == "Picture Span" ~ "Successive",
      scale == "Letter-Number Sequencing" ~ "Successive",
      scale == "Coding" ~ "Planning",
      scale == "Symbol Search" ~ "Attention",
      scale == "Cancellation" ~ "Attention",
      TRUE ~ as.character(pass)
    )
  )
```

```{r pass-table2}
table2 <-
  table2 |>
  mutate(
    pass = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Successive",
      scale == "Visual Spatial (VSI)" ~ "Simultaneous",
      scale == "Fluid Reasoning (FRI)" ~ "Simultaneous",
      scale == "Working Memory (WMI)" ~ "Attention",
      scale == "Processing Speed (PSI)" ~ "Planning",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      TRUE ~ as.character(pass)
    )
  )
```

```{r pass-table3}
table3 <-
  table3 |>
  mutate(
    pass = case_when(
      scale == "General Ability (GAI)" ~ "",
      scale == "Cognitive Proficiency (CPI)" ~ "",
      scale == "Nonverbal (NVI)" ~ "Simultaneous",
      scale == "Auditory Working Memory (AWMI)" ~ "Successive",
      scale == "Expanded Fluid (EFI)" ~ "Simultaneous",
      scale == "Quantitative Reasoning (QRI)" ~ "Simultaneous",
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "Successive",
      scale == "Naming Speed (NSI)" ~ "Attention",
      scale == "Storage & Retrieval (SRI)" ~ "Simultaneous",
      scale == "Symbol Translation (STI)" ~ "Simultaneous",
      TRUE ~ as.character(pass)
    )
  )
```

```{r pass-table4}
table4 <-
  table4 |>
  mutate(
    pass = case_when(
      scale == "Block Design No Time Bonus" ~ "Simultaneous",
      scale == "Block Design Partial Score" ~ "Simultaneous",
      scale == "Cancellation Random" ~ "Attention",
      scale == "Cancellation Structured" ~ "Attention",
      scale == "Digit Span Backward" ~ "Successive",
      scale == "Digit Span Forward" ~ "Successive",
      scale == "Digit Span Sequencing" ~ "Successive",
      TRUE ~ as.character(pass)
    )
  )
```

```{r pass-table6}
# table5 <-
#   table5 |>
#   mutate(
#     pass = case_when(
#       scale == "Naming Speed Literacy" ~ "Successive",
#       scale == "Naming Speed Quantity" ~ "Successive",
#       scale == "Immediate Symbol Translation" ~ "Simultaneous",
#       scale == "Delayed Symbol Translation" ~ "Simultaneous",
#       scale == "Recognition Symbol Translation" ~ "Simultaneous",
#       TRUE ~ as.character(pass)
#     )
#   )
```

```{r pass-table5}
# table6 <-
#   table6 |>
#   mutate(
#     pass = case_when(
#       scale == "Block Design Dimension Errors" ~ "Simultaneous",
#       scale == "Block Design Rotation Errors" ~ "Simultaneous",
#       scale == "Coding Rotation Errors" ~ "Planning",
#       scale == "Longest Digit Span Backward" ~ "Successive",
#       scale == "Longest Digit Span Forward" ~ "Successive",
#       scale == "Longest Digit Span Sequence" ~ "Successive",
#       scale == "Longest Letter-Number Sequence" ~ "Successive",
#       scale == "Longest Picture Span Response" ~ "Successive",
#       scale == "Longest Picture Span Stimulus" ~ "Successive",
#       scale == "Naming Speed Literacy Errors" ~ "Successive",
#       scale == "Naming Speed Quantity Errors" ~ "Successive",
#       scale == "Symbol Search Rotation Errors" ~ "Attention",
#       scale == "Symbol Search Set Errors" ~ "Attention",
#       TRUE ~ as.character(pass)
#     )
#   )
```

## Verbal vs Nonverbal

As necessary.

```{r verbal-table1}
table1 <-
  table1 |>
  mutate(
    verbal = case_when(
      scale == "Information" ~ "Verbal",
      scale == "Similarities" ~ "Verbal",
      scale == "Vocabulary" ~ "Verbal",
      scale == "Comprehension" ~ "Verbal",
      scale == "Block Design" ~ "Nonverbal",
      scale == "Visual Puzzles" ~ "Nonverbal",
      scale == "Matrix Reasoning" ~ "Nonverbal",
      scale == "Figure Weights" ~ "Nonverbal",
      scale == "Picture Concepts" ~ "Nonverbal",
      scale == "Arithmetic" ~ "Verbal",
      scale == "Digit Span" ~ "Verbal",
      scale == "Picture Span" ~ "Nonverbal",
      scale == "Letter-Number Sequencing" ~ "Verbal",
      scale == "Coding" ~ "Nonverbal",
      scale == "Symbol Search" ~ "Nonverbal",
      scale == "Cancellation" ~ "Nonverbal",
      TRUE ~ as.character(verbal)
    )
  )
```

```{r verbal-table2}
table2 <-
  table2 |>
  mutate(
    verbal = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Verbal",
      scale == "Visual Spatial (VSI)" ~ "Nonverbal",
      scale == "Fluid Reasoning (FRI)" ~ "Nonverbal",
      scale == "Working Memory (WMI)" ~ "Verbal",
      scale == "Processing Speed (PSI)" ~ "Nonverbal",
      scale == "Full Scale IQ (FSIQ)" ~ "",
      TRUE ~ as.character(verbal)
    )
  )
```

```{r verbal-table3}
table3 <-
  table3 |>
  mutate(
    verbal = case_when(
      scale == "Auditory Working Memory (AWMI)" ~ "Verbal",
      scale == "Cognitive Proficiency (CPI)" ~ "",
      scale == "Expanded Fluid (EFI)" ~ "Nonverbal",
      scale == "General Ability (GAI)" ~ "",
      scale == "Nonverbal (NVI)" ~ "Nonverbal",
      scale == "Quantitative Reasoning (QRI)" ~ "",
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "Verbal",
      scale == "Naming Speed (NSI)" ~ "Verbal",
      scale == "Storage & Retrieval (SRI)" ~ "Verbal",
      scale == "Symbol Translation (STI)" ~ "Nonverbal",
      TRUE ~ as.character(verbal)
    )
  )
```

```{r verbal-table4}
table4 <-
  table4 |>
  mutate(
    verbal = case_when(
      scale == "Block Design No Time Bonus" ~ "Nonverbal",
      scale == "Block Design Partial Score" ~ "Nonverbal",
      scale == "Cancellation Random" ~ "Nonverbal",
      scale == "Cancellation Structured" ~ "Nonverbal",
      scale == "Digit Span Backward" ~ "Verbal",
      scale == "Digit Span Forward" ~ "Verbal",
      scale == "Digit Span Sequencing" ~ "Verbal",
      TRUE ~ as.character(verbal)
    )
  )
```

```{r verbal-table4}
# table4 <-
#   table4 |>
#   mutate(
#     verbal = case_when(
#       scale == "Naming Speed Literacy" ~ "Verbal",
#       scale == "Naming Speed Quantity" ~ "Verbal",
#       scale == "Immediate Symbol Translation" ~ "Nonverbal",
#       scale == "Delayed Symbol Translation" ~ "Nonverbal",
#       scale == "Recognition Symbol Translation" ~ "Nonverbal",
#       TRUE ~ as.character(verbal)
#     )
#   )
```

```{r verbal-table6}
# table6 <-
#   table6 |>
#   mutate(
#     verbal = case_when(
#       scale == "Block Design Dimension Errors" ~ "Nonverbal",
#       scale == "Block Design Rotation Errors" ~ "Nonverbal",
#       scale == "Coding Rotation Errors" ~ "Nonverbal",
#       scale == "Longest Digit Span Backward" ~ "Verbal",
#       scale == "Longest Digit Span Forward" ~ "Verbal",
#       scale == "Longest Digit Span Sequence" ~ "Verbal",
#       scale == "Longest Letter-Number Sequence" ~ "Verbal",
#       scale == "Longest Picture Span Response" ~ "Nonverbal",
#       scale == "Longest Picture Span Stimulus" ~ "Nonverbal",
#       scale == "Naming Speed Literacy Errors" ~ "Verbal",
#       scale == "Naming Speed Quantity Errors" ~ "Verbal",
#       scale == "Symbol Search Rotation Errors" ~ "Nonverbal",
#       scale == "Symbol Search Set Errors" ~ "Nonverbal",
#       TRUE ~ as.character(verbal)
#     )
#   )
```

## Timed vs Untimed

As necessary.

```{r timed-table1}
table1 <-
  table1 |>
  mutate(
    timed = case_when(
      scale == "Arithmetic" ~ "Timed",
      scale == "Block Design" ~ "Timed",
      scale == "Cancellation" ~ "Timed",
      scale == "Coding" ~ "Timed",
      scale == "Comprehension" ~ "Untimed",
      scale == "Digit Span" ~ "Untimed",
      scale == "Figure Weights" ~ "Timed",
      scale == "Information" ~ "Untimed",
      scale == "Letter-Number Sequencing" ~ "Untimed",
      scale == "Matrix Reasoning" ~ "Untimed",
      scale == "Picture Concepts" ~ "Untimed",
      scale == "Picture Span" ~ "Untimed",
      scale == "Similarities" ~ "Untimed",
      scale == "Symbol Search" ~ "Timed",
      scale == "Visual Puzzles" ~ "Timed",
      scale == "Vocabulary" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

```{r timed-table2}
table2 <-
  table2 |>
  mutate(
    timed = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "Untimed",
      scale == "Visual Spatial (VSI)" ~ "Timed",
      scale == "Fluid Reasoning (FRI)" ~ "Timed",
      scale == "Working Memory (WMI)" ~ "Untimed",
      scale == "Processing Speed (PSI)" ~ "Timed",
      scale == "Full Scale IQ (FSIQ)" ~ "Timed",
      TRUE ~ as.character(timed)
    )
  )
```

```{r timed-table3}
table3 <-
  table3 |>
  mutate(
    timed = case_when(
      scale == "Auditory Working Memory (AWMI)" ~ "Untimed",
      scale == "Cognitive Proficiency (CPI)" ~ "Timed",
      scale == "Expanded Fluid (EFI)" ~ "Untimed",
      scale == "General Ability (GAI)" ~ "Untimed",
      scale == "Nonverbal (NVI)" ~ "Timed",
      scale == "Quantitative Reasoning (QRI)" ~ "Timed",
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "Untimed",
      scale == "Naming Speed (NSI)" ~ "Timed",
      scale == "Storage & Retrieval (SRI)" ~ "Timed",
      scale == "Symbol Translation (STI)" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

```{r timed-table4}
table4 <-
  table4 |>
  mutate(
    timed = case_when(
      scale == "Block Design No Time Bonus" ~ "Untimed",
      scale == "Block Design Partial Score" ~ "Untimed",
      scale == "Cancellation Random" ~ "Timed",
      scale == "Cancellation Structured" ~ "Timed",
      scale == "Digit Span Backward" ~ "Untimed",
      scale == "Digit Span Forward" ~ "Untimed",
      scale == "Digit Span Sequencing" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

```{r timed-table4}
# table4 <-
#   table4 |>
#   mutate(
#     timed = case_when(
#       scale == "Naming Speed Literacy" ~ "Timed",
#       scale == "Naming Speed Quantity" ~ "Timed",
#       scale == "Immediate Symbol Translation" ~ "Untimed",
#       scale == "Delayed Symbol Translation" ~ "Untimed",
#       scale == "Recognition Symbol Translation" ~ "Untimed",
#       Timed ~ as.character(timed)
#     )
#   )
```

```{r timed-table6}
# table6 <-
#   table6 |>
#   mutate(
#     timed = case_when(
#       scale == "Block Design Dimension Errors" ~ "Timed",
#       scale == "Block Design Rotation Errors" ~ "Timed",
#       scale == "Coding Rotation Errors" ~ "Timed",
#       scale == "Longest Digit Span Backward" ~ "Untimed",
#       scale == "Longest Digit Span Forward" ~ "Untimed",
#       scale == "Longest Digit Span Sequence" ~ "Untimed",
#       scale == "Longest Letter-Number Sequence" ~ "Untimed",
#       scale == "Longest Picture Span Response" ~ "Untimed",
#       scale == "Longest Picture Span Stimulus" ~ "Untimed",
#       scale == "Naming Speed Literacy Errors" ~ "Timed",
#       scale == "Naming Speed Quantity Errors" ~ "Timed",
#       scale == "Symbol Search Rotation Errors" ~ "Timed",
#       scale == "Symbol Search Set Errors" ~ "Timed",
#       TRUE ~ as.character(timed)
#     )
#   )
```

## Description of test

As necessary.

```{r description-table1}
table1 <-
  table1 |>
  mutate(
    description = case_when(
      scale == "Similarities" ~ "verbal concept formation and abstract reasoning",
      scale == "Vocabulary" ~ "verbal concept formation and word knowledge",
      scale == "Information" ~ "acquired knowledge/ability to acquire, retain, and retrieve general factual knowledge",
      scale == "Comprehension" ~ "practical knowledge and judgment of general principles and social situations",
      scale == "Block Design" ~ "visual-spatial processing and visual-motor integration",
      scale == "Visual Puzzles" ~ "analyze and synthesize abstract visual stimuli",
      scale == "Matrix Reasoning" ~ "fluid intelligence, classificaiton and spatial ability, simultaneous processing, attention to visual detail, and working memory",
      scale == "Figure Weights" ~ "quantitative and inductive reasoning, mental flexibility, and set shifting",
      scale == "Picture Concepts" ~ "fluid and inductive reasoning, and conceptual thinking",
      scale == "Arithmetic" ~ "mental manipulation, concentration, and working memory; short- and long-term memory; fluid, quantitative, and logical reasoning; sequential processing; and quantiative knowledge",
      scale == "Digit Span" ~ "working memory, in addition to auditory attention, sequential processing, and mental manipulation",
      scale == "Picture Span" ~ "visual/nonverbal working memory and working memory capacity",
      scale == "Letter-Number Sequencing" ~ "sequencing and working memory, as well as auditory sequential processing, immediate auditory memory, attention, numerical ability, and visual-spatial imaging",
      scale == "Coding" ~ "visual-motor processing speed, as well as graphomotor speed, short-term memory, learning ability, visual acuity, sequential processing, and attention to visual stimuli",
      scale == "Symbol Search" ~ "visual-motor processing speed, as well as short-term visual memory, perceputal organization, learning ability, perceptual and psychomotor speed, visual-motor coordination, visual discrimination, and attention to visual stimuli",
      scale == "Cancellation" ~ "selective visual attention, rate of test-taking, perceptual speed, visual discrimination, and visual-perceptual processing",
      TRUE ~ as.character(description)
    )
  )
```

```{r description-table2}
table2 <-
  table2 |>
  mutate(
    description = case_when(
      scale == "Verbal Comprehension (VCI)" ~ "ability to verbalize meaningful concepts, think about verbal information, and express oneself using words; verbal concept formation, verbal reasoning, verbal comprehension and expression, acquired knowledge, and practical knowledge and judgment",
      scale == "Visual Spatial (VSI)" ~ "ability to evaluate visual details, undertand spatial relations among objects, and construct geometric design using models",
      scale == "Fluid Reasoning (FRI)" ~ "ability to use reasoning to identify and apply solutions to problems",
      scale == "Working Memory (WMI)" ~ "ability to consciously register, maintain, and manipulate auditory and visual information",
      scale == "Processing Speed (PSI)" ~ "ability to quickly use reasoning to identfy and apply soluations to problems",
      scale == "Full Scale IQ (FSIQ)" ~ "general intellectual ability",
      TRUE ~ as.character(description)
    )
  )
```

```{r description-table3}
table3 <-
  table3 |>
  mutate(
    description = case_when(
      ## Ancillary
      scale == "Verbal (Expanded Crystallized) (VECI)" ~ "verbal concept formation, verbal reasoning, verbal comprehension and expression, acquired knowledge, and practical knowledge and judgment (expanded)",
      scale == "Expanded Fluid (EFI)" ~ "ability to use reasoning to identify and apply solutions to problems (expanded)",
      scale == "Quantitative Reasoning (QRI)" ~ "quantitative reasoning skills",
      scale == "Auditory Working Memory (AWMI)" ~ "auditory working memory processes supported by the phonological loop; ability to register, maintain, and manipulate verbally-presented information",
      scale == "Nonverbal (NVI)" ~ "general intellectual functioning that minimizes expressive language demands",
      scale == "General Ability (GAI)" ~ "a subset of intellectual functioning with reduced influences of working memory and processing speed",
      scale == "Cognitive Proficiency (CPI)" ~ "index of cognitive processing proficiency that reduces crystallzied knowledge, verbal reaoning, and fluid reasoning demands",
      ## Complementary
      scale == "Naming Speed (NSI)" ~ "automaticity of naming",
      scale == "Symbol Translation (STI)" ~ "visual-verbal associative memory",
      scale == "Storage & Retrieval (SRI)" ~ "ability to accurately and efficiently store and retrieve auditory and visual information fromlong-term memory",
      TRUE ~ as.character(description)
    )
  )
```

```{r description-table4}
table4 <-
  table4 |>
  mutate(
    description = case_when(
      scale == "Block Design No Time Bonus" ~ "visuoconstruction and integration of blocks (untimed)",
      scale == "Block Design Partial Score" ~ "visuoconstruction and integration of blocks (total correct)",
      scale == "Digit Span Backward" ~ "recall of digits backward",
      scale == "Digit Span Forward" ~ "recall of digits forward",
      scale == "Digit Span Sequencing" ~ "recall of digits sequentially",
      scale == "Cancellation Random" ~ "rate of test-taking, perceptual speed, visual discrimination, and visual attention/scanning (random)",
      scale == "Cancellation Structured" ~ "rate of test-taking, perceptual speed, visual discrimination, and visual attention/scanning (structured)",
      TRUE ~ as.character(description)
    )
  )
```

```{r description-table4}
# table4 <-
#   table4 |>
#   mutate(
#     description = case_when(
#       ## Complimentary
#       scale == "Naming Speed Literacy" ~ "naming speed for objects/letters/numbers",
#       scale == "Naming Speed Quantity" ~ "naming speed for quantities",
#       scale == "Immediate Symbol Translation" ~ "visual-verbal associative memory learning",
#       scale == "Delayed Symbol Translation" ~ "visual-verbal associative memory recall",
#       scale == "Recognition Symbol Translation" ~ "visual-verbal associative memory recognition",
#       TRUE ~ as.character(description)
#     )
#   )
```

```{r description-table6}
# table6 <-
#   table6 |>
#   mutate(
#     description = case_when(
#       scale == "Block Design Dimension Errors" ~ "visuoconstruction and integration of blocks (dimension errors)",
#       scale == "Block Design Rotation Errors" ~ "visuoconstruction and integration of blocks (rotation errors)",
#       scale == "Longest Digit Span Backward" ~ "recall of digits forward and backward",
#       scale == "Longest Digit Span Forward" ~ "recall of digits forward and backward",
#       scale == "Longest Digit Span Sequence" ~ "recall of digits forward and backward",
#       scale == "Longest Letter-Number Sequence" ~ "recalling and reordering progressively longer series of digits and letters",
#       scale == "Symbol Search Rotation Errors" ~ "processing speed, attention, and concentration (rotation errors)",
#       scale == "Symbol Search Set Errors" ~ "processing speed, attention, and concentration (set errors)",
#       scale == "Naming Speed Literacy Errors" ~ "naming speed for objects/letters/numbers (errors)",
#       scale == "Naming Speed Quantity Errors" ~ "naming speed for quantities (errors)",
#       scale == "Longest Picture Span Response" ~ "visual/nonverbal working memory and working memory capacity (response)",
#       scale == "Longest Picture Span Stimulus" ~ "visual/nonverbal working memory and working memory capacity (stimulus)",
#       scale == "Coding Rotation Errors" ~ "visual-motor processing speed (rotation errors)",
#       TRUE ~ as.character(description)
#     )
#   )
```

# Finalize and save

## Relocate variables

```{r relocate}
table1 <- table1 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
table2 <- table2 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
table3 <- table3 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
table4 <- table4 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
# table5 <- table5 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
# table6 <- table6 |> relocate(c(raw_score, score, percentile, range, ci_95), .before = test)
```
